<?php
// File Manager Sederhana
// HARAP HATI-HATI: Hanya gunakan di lingkungan lokal/terpercaya

session_start();

// Konfigurasi keamanan dasar
$allowed_dirs = [
    'uploads' => 'Uploads',
    '.' => 'Root Folder'
];

// Default directory
$current_dir = isset($_GET['dir']) ? $_GET['dir'] : '.';

// Validasi directory untuk mencegah directory traversal
if (!array_key_exists($current_dir, $allowed_dirs)) {
    $current_dir = '.';
}

// Set working directory
chdir(dirname(__FILE__));
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple File Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .alert {
            background-color: #e74c3c;
            color: white;
            padding: 10px;
            margin: 15px;
            border-radius: 5px;
            text-align: center;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            padding: 20px;
        }
        
        .sidebar {
            flex: 1;
            min-width: 250px;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-right: 20px;
        }
        
        .file-list {
            flex: 3;
            min-width: 300px;
        }
        
        h2 {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            color: #2c3e50;
        }
        
        .breadcrumb {
            background-color: #ecf0f1;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .breadcrumb a {
            color: #3498db;
            text-decoration: none;
        }
        
        .breadcrumb span {
            color: #7f8c8d;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        tr:hover {
            background-color: #f9f9f9;
        }
        
        .file-icon {
            width: 24px;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        .folder {
            color: #3498db;
            font-weight: bold;
        }
        
        .file {
            color: #7f8c8d;
        }
        
        .actions {
            display: flex;
            gap: 5px;
        }
        
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-view {
            background-color: #3498db;
            color: white;
        }
        
        .btn-delete {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-download {
            background-color: #2ecc71;
            color: white;
        }
        
        .form-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        input[type="text"],
        input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .btn-submit {
            background-color: #2c3e50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .btn-submit:hover {
            background-color: #1a252f;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            background-color: #f8f9fa;
            color: #7f8c8d;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                margin-right: 0;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìÅ Simple File Manager</h1>
            <p>Manage your files and folders securely</p>
        </header>
        
        <?php if (isset($_SESSION['message'])): ?>
            <div class="alert"><?php echo $_SESSION['message']; unset($_SESSION['message']); ?></div>
        <?php endif; ?>
        
        <div class="main-content">
            <div class="sidebar">
                <h2>üìÇ Navigation</h2>
                <div class="breadcrumb">
                    <?php
                    echo '<a href="index.php?dir=.">Root</a>';
                    if ($current_dir != '.') {
                        echo ' / <span>' . htmlspecialchars($allowed_dirs[$current_dir]) . '</span>';
                    }
                    ?>
                </div>
                
                <div class="form-section">
                    <h3>‚ûï Create New Folder</h3>
                    <form action="file-manager.php" method="POST">
                        <input type="hidden" name="action" value="create_folder">
                        <input type="hidden" name="current_dir" value="<?php echo htmlspecialchars($current_dir); ?>">
                        <div class="form-group">
                            <label for="folder_name">Folder Name:</label>
                            <input type="text" id="folder_name" name="folder_name" required placeholder="Enter folder name">
                        </div>
                        <button type="submit" class="btn-submit">Create Folder</button>
                    </form>
                </div>
                
                <div class="form-section">
                    <h3>üì§ Upload File</h3>
                    <form action="file-manager.php" method="POST" enctype="multipart/form-data">
                        <input type="hidden" name="action" value="upload">
                        <input type="hidden" name="current_dir" value="<?php echo htmlspecialchars($current_dir); ?>">
                        <div class="form-group">
                            <label for="file">Select File:</label>
                            <input type="file" id="file" name="file" required>
                        </div>
                        <button type="submit" class="btn-submit">Upload File</button>
                    </form>
                </div>
            </div>
            
            <div class="file-list">
                <h2>üìã Files & Folders in <?php echo htmlspecialchars($allowed_dirs[$current_dir]); ?></h2>
                
                <?php
                // Tampilkan daftar file dan folder
                $dir_contents = scandir($current_dir);
                if ($dir_contents !== false) {
                    $folders = [];
                    $files = [];
                    
                    foreach ($dir_contents as $item) {
                        if ($item == '.' || $item == '..') continue;
                        
                        $path = $current_dir . '/' . $item;
                        if (is_dir($path)) {
                            $folders[] = $item;
                        } else {
                            $files[] = $item;
                        }
                    }
                    
                    // Urutkan: folder dulu, lalu file
                    sort($folders);
                    sort($files);
                    
                    echo '<table>';
                    echo '<thead><tr><th>Name</th><th>Type</th><th>Size</th><th>Modified</th><th>Actions</th></tr></thead>';
                    echo '<tbody>';
                    
                    // Tampilkan folder
                    foreach ($folders as $item) {
                        $path = $current_dir . '/' . $item;
                        $mod_time = date("Y-m-d H:i:s", filemtime($path));
                        
                        echo '<tr>';
                        echo '<td><span class="folder">üìÅ ' . htmlspecialchars($item) . '</span></td>';
                        echo '<td>Folder</td>';
                        echo '<td>--</td>';
                        echo '<td>' . $mod_time . '</td>';
                        echo '<td class="actions">';
                        echo '<a href="index.php?dir=' . urlencode($path) . '" class="btn btn-view">Open</a>';
                        echo '<a href="file-manager.php?action=delete&path=' . urlencode($path) . '&current_dir=' . urlencode($current_dir) . '" class="btn btn-delete" onclick="return confirm(\'Are you sure?\')">Delete</a>';
                        echo '</td>';
                        echo '</tr>';
                    }
                    
                    // Tampilkan file
                    foreach ($files as $item) {
                        $path = $current_dir . '/' . $item;
                        $size = filesize($path);
                        $mod_time = date("Y-m-d H:i:s", filemtime($path));
                        $ext = pathinfo($item, PATHINFO_EXTENSION);
                        
                        // Format ukuran file
                        if ($size < 1024) {
                            $size_display = $size . ' B';
                        } elseif ($size < 1048576) {
                            $size_display = round($size / 1024, 2) . ' KB';
                        } else {
                            $size_display = round($size / 1048576, 2) . ' MB';
                        }
                        
                        // Icon berdasarkan tipe file
                        $icon = 'üìÑ';
                        if (in_array($ext, ['jpg', 'jpeg', 'png', 'gif'])) $icon = 'üñºÔ∏è';
                        if (in_array($ext, ['pdf'])) $icon = 'üìï';
                        if (in_array($ext, ['doc', 'docx'])) $icon = 'üìò';
                        if (in_array($ext, ['xls', 'xlsx'])) $icon = 'üìó';
                        if (in_array($ext, ['zip', 'rar', 'tar'])) $icon = 'üì¶';
                        
                        echo '<tr>';
                        echo '<td><span class="file">' . $icon . ' ' . htmlspecialchars($item) . '</span></td>';
                        echo '<td>' . strtoupper($ext) . ' File</td>';
                        echo '<td>' . $size_display . '</td>';
                        echo '<td>' . $mod_time . '</td>';
                        echo '<td class="actions">';
                        
                        // Tentukan apakah file dapat dilihat (file teks)
                        $text_extensions = ['txt', 'php', 'html', 'css', 'js', 'json', 'xml', 'md'];
                        if (in_array($ext, $text_extensions)) {
                            echo '<a href="file-manager.php?action=view&path=' . urlencode($path) . '" class="btn btn-view" target="_blank">View</a>';
                        }
                        
                        echo '<a href="file-manager.php?action=download&path=' . urlencode($path) . '" class="btn btn-download">Download</a>';
                        echo '<a href="file-manager.php?action=delete&path=' . urlencode($path) . '&current_dir=' . urlencode($current_dir) . '" class="btn btn-delete" onclick="return confirm(\'Are you sure?\')">Delete</a>';
                        echo '</td>';
                        echo '</tr>';
                    }
                    
                    echo '</tbody></table>';
                    
                    if (empty($folders) && empty($files)) {
                        echo '<p>No files or folders in this directory.</p>';
                    }
                } else {
                    echo '<p>Unable to read directory.</p>';
                }
                ?>
            </div>
        </div>
        
        <footer>
            <p>‚ö†Ô∏è <strong>Security Note:</strong> This file manager is for local/trusted environments only.</p>
            <p>Simple File Manager &copy; <?php echo date('Y'); ?></p>
        </footer>
    </div>
</body>
</html>
